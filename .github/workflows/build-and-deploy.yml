name: Build & Deploy .NET 8 Service

on:
  push:
    branches: 
        - master
  workflow_dispatch:

permissions:
  contents: read
  packages: write

env:
  DOTNET_VERSION: "8.0.x"
  SOLUTION_PATH: IGCSELearningHub.sln
  PROJECT_PATH: WebAPI/WebAPI.csproj
  DOCKERFILE_PATH: WebAPI/Dockerfile
  REGISTRY: ghcr.io
  IMAGE_TAG: ${{ github.sha }}

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    outputs:
      image: ${{ steps.docker_build.outputs.image }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Cache NuGet
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: ${{ runner.os }}-nuget-

      - name: Restore
        run: dotnet restore ${{ env.SOLUTION_PATH }}
  
      - name: Build (Release)
        run: dotnet build ${{ env.SOLUTION_PATH }} -c Release --no-restore
  
      - name: Test
        run: dotnet test ${{ env.SOLUTION_PATH }} -c Release --no-build --verbosity normal || true
  
      - name: Log in to container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Docker image
        id: docker_build
        run: |
          IMAGE_REPO="${{ env.REGISTRY }}/$(echo '${{ github.repository }}' | tr '[:upper:]' '[:lower:]')"
          IMAGE_TAG="${{ env.IMAGE_TAG }}"
          FULL_IMAGE="$IMAGE_REPO:$IMAGE_TAG"
          docker build -f "${{ env.DOCKERFILE_PATH }}" -t "$FULL_IMAGE" .
          echo "image=$FULL_IMAGE" >> "$GITHUB_OUTPUT"

      - name: Push Docker image
        run: docker push ${{ steps.docker_build.outputs.image }}

  deploy:
    needs: build
    runs-on: ubuntu-latest
    strategy:
      matrix:
        target:
          - name: production
            service_id_secret: RENDER_SERVICE_ID_PRODUCTION
            url: https://igcse-learninghub-api.onrender.com
    environment:
      name: ${{ matrix.target.name }}
      url: ${{ matrix.target.url }}

    steps:
      - name: Trigger Render deploy
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets[matrix.target.service_id_secret] }}
          IMAGE: ${{ needs.build.outputs.image }}
        run: |
          if [ -z "$RENDER_API_KEY" ] || [ -z "$RENDER_SERVICE_ID" ]; then
            echo "Render credentials are not fully configured" >&2
            exit 1
          fi
          curl -fsS -X POST \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            -H "Content-Type: application/json" \
            "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys" \
            -d "{\"image\":\"$IMAGE\"}"
